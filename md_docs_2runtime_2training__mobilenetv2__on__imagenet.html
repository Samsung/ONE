<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ONE - On-device Neural Engine: Training MobileNetV2 on ImageNet Dataset using ONERT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ONE - On-device Neural Engine
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2runtime_2training__mobilenetv2__on__imagenet.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Training MobileNetV2 on ImageNet Dataset using ONERT</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Let's train a MobileNetV2 model on ImageNet Dataset using ONERT.</p>
<h1>Prepare dataset</h1>
<p>ImageNet dataset is an image database organized according to the WordNet hierarchy in which each node of hierarchy is depicted by hundreds and thousands of images. ImageNet contains more than 20,000 categories, with a typical category, such as "balloon" or "strawberry", consisting of several hundred images. There are serveral versions of ImageNet dataset in the TensorFlow datasets. Among them, ImageNet-A dataset is used in this document. ImageNet-A is a set of images labelled with ImageNet labels that were obtained by collecting new data and keeping only those images that ResNet-50 models fail to correctly classify. ONERT provides a <code>tf_dataset_converter</code> tool to download ImageNet-A dataset from TensorFlow Datasets and converts it to binary format for ONERT training.</p>
<div class="fragment"><div class="line">$ python3 tools/generate_datafile/tf_dataset_converter/main.py \</div>
<div class="line">--dataset-name imagenet_a \</div>
<div class="line">--prefix-name imagenet_a \</div>
<div class="line">--split test \</div>
<div class="line">--length 100 \</div>
<div class="line">--model mobilenetv2</div>
<div class="line">Shape of images : (224, 224, 3)</div>
<div class="line">Shape of labels: () &lt;dtype: &#39;int64&#39;&gt;</div>
<div class="line">class names[:10]  : [&#39;n01440764&#39;, &#39;n01443537&#39;, &#39;n01484850&#39;, &#39;n01491361&#39;, &#39;n01494475&#39;, &#39;n01496331&#39;, &#39;n01498041&#39;, &#39;n01514668&#39;, &#39;n01514859&#39;, &#39;n01518878&#39;]</div>
<div class="line">class length      : 1000</div>
<div class="line">The data files are created!</div>
<div class="line">$ tree out</div>
<div class="line">out</div>
<div class="line">├── imagenet_a.test.input.100.bin</div>
<div class="line">└── imagenet_a.test.output.100.bin</div>
<div class="line"> </div>
<div class="line">0 directories, 2 files</div>
</div><!-- fragment --><h1>Prepare model</h1>
<p>Download MobileNetV2 model from TensorFlow Keras Application. This code generates a <code>model.tflite</code> TFLite model file.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div>
<div class="line"> </div>
<div class="line">model = tf.keras.applications.mobilenet_v2.MobileNetV2(input_shape=(224,224,3))</div>
<div class="line"> </div>
<div class="line">converter = tf.lite.TFLiteConverter.from_keras_model(model)</div>
<div class="line">tflite_model = converter.convert()</div>
<div class="line"> </div>
<div class="line"><span class="keyword">with</span> open(<span class="stringliteral">&#39;model.tflite&#39;</span>, <span class="stringliteral">&#39;wb&#39;</span>) <span class="keyword">as</span> f:</div>
<div class="line">    f.write(tflite_model)</div>
</div><!-- fragment --><h1>Convert tflite model to circle model</h1>
<p>ONERT can take a model from a tflite file or a circle file. So you can use this tflite model file directly. To use the circle model instead of the tflite model, you must convert it to the circle model using the 'onecc' tool, and 'onecc' can only be used in Ubuntu. When the ‘one-compiler’ debian package is installed on the <a href="https://github.com/Samsung/ONE/releases">ONE release page</a>, it is installed in the ‘/usr/share/one/bin’ directory. Please refer to the help for detailed guidelines. The following command converts the tflite model into a circle model.</p>
<div class="fragment"><div class="line">$ onecc import tflite -- -i ./model.tflite -o ./model.circle</div>
</div><!-- fragment --><h1>Run training</h1>
<p>Let's train the model using <code>onert_train</code>.</p>
<div class="fragment"><div class="line">$ ./Product/out/bin/onert_train \</div>
<div class="line">--epoch 5 \</div>
<div class="line">--loss 2 \                      # categorical crossentropy</div>
<div class="line">--loss_reduction_type 1 \       # sum over batch size</div>
<div class="line">--optimizer 2 \                 # adam</div>
<div class="line">--learning_rate 0.001 \</div>
<div class="line">--batch_size 10 \</div>
<div class="line">--num_of_trainable_ops -1 \     # train all operations</div>
<div class="line">--load_input:raw ./out/imagenet_a.test.input.100.bin \</div>
<div class="line">--load_expected:raw ./out/imagenet_a.test.output.100.bin \</div>
<div class="line">model.circle</div>
</div><!-- fragment --><p>The result of training: </p><div class="fragment"><div class="line">Model Filename model.circle</div>
<div class="line">== training parameter ==</div>
<div class="line">- learning_rate        = 0.001</div>
<div class="line">- batch_size           = 10</div>
<div class="line">- loss_info            = {loss = categorical crossentropy, reduction = sum over batch size}</div>
<div class="line">- optimizer            = adam</div>
<div class="line">- num_of_trainable_ops = -1</div>
<div class="line">========================</div>
<div class="line">Epoch 1/5 - time: 486.584ms/step - loss: [0] 7.2355</div>
<div class="line">Epoch 2/5 - time: 483.868ms/step - loss: [0] 5.5251</div>
<div class="line">Epoch 3/5 - time: 468.033ms/step - loss: [0] 4.6092</div>
<div class="line">Epoch 4/5 - time: 481.408ms/step - loss: [0] 4.3135</div>
<div class="line">Epoch 5/5 - time: 478.066ms/step - loss: [0] 4.2332</div>
<div class="line">===================================</div>
<div class="line">MODEL_LOAD   takes 14.1350 ms</div>
<div class="line">PREPARE      takes 227.5800 ms</div>
<div class="line">EXECUTE      takes 24018.8730 ms</div>
<div class="line">- Epoch 1      takes 4865.8380 ms</div>
<div class="line">- Epoch 2      takes 4838.6810 ms</div>
<div class="line">- Epoch 3      takes 4680.3250 ms</div>
<div class="line">- Epoch 4      takes 4814.0820 ms</div>
<div class="line">- Epoch 5      takes 4780.6580 ms</div>
<div class="line">===================================</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
