<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ONE - On-device Neural Engine: Training a simple CNN model on MNIST using ONERT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ONE - On-device Neural Engine
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2runtime_2training__cnn__on__mnist.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Training a simple CNN model on MNIST using ONERT</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Let's train a simple neural network on MNIST dataset using ONERT.</p>
<h1>Prepare dataset</h1>
<p>MNIST dataset consists of 60,000 training images and 10,000 test images. Each image is a 28x28 grayscale image, associated with a label from 10 classes. This dataset is available in TensorFlow datasets. ONERT provides a <code>tf_dataset_converter</code> tool to download dataset from TensorFlow Datasets and converts it to binary format for ONERT training.</p>
<div class="fragment"><div class="line">$ python3 tools/generate_datafile/tf_dataset_converter/main.py \</div>
<div class="line">--dataset-name fashion_mnist --prefix-name fashion-mnist --model mnist</div>
<div class="line">Shape of images : (28, 28, 1)</div>
<div class="line">Shape of labels: () &lt;dtype: &#39;int64&#39;&gt;</div>
<div class="line">class names[:10]  : [&#39;T-shirt/top&#39;, &#39;Trouser&#39;, &#39;Pullover&#39;, &#39;Dress&#39;, &#39;Coat&#39;, &#39;Sandal&#39;, &#39;Shirt&#39;, &#39;Sneaker&#39;, &#39;Bag&#39;, &#39;Ankle boot&#39;]</div>
<div class="line">class length      : 10</div>
<div class="line">The data files are created!</div>
<div class="line">$ tree out</div>
<div class="line">out</div>
<div class="line">├── fashion-mnist.test.input.100.bin</div>
<div class="line">├── fashion-mnist.test.output.100.bin</div>
<div class="line">├── fashion-mnist.train.input.1000.bin</div>
<div class="line">└── fashion-mnist.train.output.1000.bin</div>
<div class="line"> </div>
<div class="line">0 directories, 4 files</div>
</div><!-- fragment --><h1>Prepare model</h1>
<p>Prepare a simple neural network for trainng MNIST datasets using the <code>tf.keras</code> API. This code generates a <code>model.tflite</code> TFLite model file.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div>
<div class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create a model</span></div>
<div class="line">model = tf.keras.models.Sequential([</div>
<div class="line">    tf.keras.layers.Flatten(input_shape=(28, 28)),</div>
<div class="line">    tf.keras.layers.Dense(128, activation=<span class="stringliteral">&#39;relu&#39;</span>),</div>
<div class="line">    tf.keras.layers.Dense(10)</div>
<div class="line">])</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Donwload train dataset</span></div>
<div class="line">ds = tfds.load(<span class="stringliteral">&#39;mnist&#39;</span>, split=<span class="stringliteral">&#39;train&#39;</span>, as_supervised=<span class="keyword">True</span>)</div>
<div class="line">ds = ds.batch(128)</div>
<div class="line"> </div>
<div class="line">model.compile(optimizer=<span class="stringliteral">&#39;adam&#39;</span>, loss=<span class="stringliteral">&#39;mean_squared_error&#39;</span>)</div>
<div class="line">model.fit(ds, epochs=5)</div>
<div class="line"> </div>
<div class="line">converter = tf.lite.TFLiteConverter.from_keras_model(model)</div>
<div class="line">tflite_model = converter.convert()</div>
<div class="line"> </div>
<div class="line"><span class="keyword">with</span> open(<span class="stringliteral">&#39;model.tflite&#39;</span>, <span class="stringliteral">&#39;wb&#39;</span>) <span class="keyword">as</span> f:</div>
<div class="line">    f.write(tflite_model)</div>
</div><!-- fragment --><h1>Convert tflite model to circle model</h1>
<p>ONERT takes both the tflite model and the circle model. So you can use this tflite model file directly. To use the circle model instead of the tflite model, you have to convert it to the circle model using the 'onecc' tool, and 'onecc' can only be used in Ubuntu. When the ‘one-compiler’ debian package is installed on the ONE release page, it is installed in the ‘/usr/share/one/bin’ directory. Please refer to the help for detailed guidelines. The following command converts the tflite model into a circle model.</p>
<div class="fragment"><div class="line">$ onecc import tflite -- -i ./model.tflite -o ./model.circle</div>
</div><!-- fragment --><h1>Run training</h1>
<p>Let's train the model using <code>onert_train</code>.</p>
<div class="fragment"><div class="line">$ ./Product/out/bin/onert_train \</div>
<div class="line">--epoch 5 \</div>
<div class="line">--loss 1 \                    # mean squared error</div>
<div class="line">--loss_reduction_type 1 \     # sum over batch size</div>
<div class="line">--optimizer 2 \               # adam</div>
<div class="line">--learning_rate 0.001 \</div>
<div class="line">--batch_size 10 \</div>
<div class="line">--num_of_trainable_ops -1 \   # train all operations</div>
<div class="line">--load_input:raw ./out/fashion-mnist.train.input.1000.bin \</div>
<div class="line">--load_expected:raw ./out/fashion-mnist.train.output.1000.bin \</div>
<div class="line">model.circle</div>
</div><!-- fragment --><p>The result of training: </p><div class="fragment"><div class="line">Model Filename model.circle</div>
<div class="line">== training parameter ==</div>
<div class="line">- learning_rate        = 0.001</div>
<div class="line">- batch_size           = 10</div>
<div class="line">- loss_info            = {loss = mean squared error, reduction = sum over batch size}</div>
<div class="line">- optimizer            = adam</div>
<div class="line">- num_of_trainable_ops = -1</div>
<div class="line">========================</div>
<div class="line">Epoch 1/5 - time: 1.602ms/step - loss: [0] 0.1082</div>
<div class="line">Epoch 2/5 - time: 1.674ms/step - loss: [0] 0.0758</div>
<div class="line">Epoch 3/5 - time: 1.624ms/step - loss: [0] 0.0611</div>
<div class="line">Epoch 4/5 - time: 1.624ms/step - loss: [0] 0.0549</div>
<div class="line">Epoch 5/5 - time: 1.635ms/step - loss: [0] 0.0516</div>
<div class="line">===================================</div>
<div class="line">MODEL_LOAD   takes 0.2440 ms</div>
<div class="line">PREPARE      takes 1.7130 ms</div>
<div class="line">EXECUTE      takes 829.2350 ms</div>
<div class="line">- Epoch 1      takes 160.1870 ms</div>
<div class="line">- Epoch 2      takes 167.4430 ms</div>
<div class="line">- Epoch 3      takes 162.4110 ms</div>
<div class="line">- Epoch 4      takes 162.4300 ms</div>
<div class="line">- Epoch 5      takes 163.5280 ms</div>
<div class="line">===================================</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
